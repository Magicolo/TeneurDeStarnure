<!DOCTYPE html>
<html>

<head>
  <style>
    ul {
      list-style: none;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>




  <script>


    var playerId = -1;
    var eventId = "";

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function ShowNode(node) {
      switch (node.Type) {
        case "Text":
          $("#output").append(node.Value);
          break;
        case "Break":
          $("#output").append("<br/>");
          break;
        case "Delay":
          await sleep(node.Time * 1000);
          break;
        case "Sequence":
          for (let i = 0; i < node.Children.length; i++) {
            const element = node.Children[i];
            await ShowNode(element);
          }
          break;
      }
    }

    async function ShowChoices(choices) {
      //console.log(choices);
      choices.forEach(function (choice) {
        choice = "<li> <label><input type=\"radio\" name=\"choice\" value=\"" + choice.Identifier + "\">" + choice.Label + "</label></li>";
        $("#choices ul").append(choice);
      });
      var btns = $("#choices ul li");
      btns.hide();
      for (let i = 1; i <= btns.length; i++) {
        var select = $("#choices ul li:nth-child(" + i + ")");
        select.show(200);
        await sleep(200);
      }

    }

    async function EmptyContent() {
      $("#sendButton").hide(200);
      await sleep(200);
      $("#choices ul").hide(200)
      await sleep(200);
      $("#output").hide(200);
      await sleep(300);

      $("#choices ul").empty();
      $("#output").empty();

      $("#choices ul").show();
      $("#output").show();
    }

    function FetchEventIdPlease() {
      $.ajax({
        url: "/user/"+playerId+"/getCurrentEventId",
        dataType: "jsonp",
        success: async function (data) {
          if (data.Success && data.Content != eventId) {
            console.log("Event changed from " + eventId + " to " + data.Content);
            eventId = data.Content;
            await EmptyContent();
            FetchEventContent();
          }
        }
      });
    }

    function FetchEventContent() {
      $.ajax({
        url: "/user/"+playerId+"/getEventContent",
        dataType: "jsonp",
        success: async function (data) {
          //console.log(data);
          if (data.Success) {
            await ShowNode(data.Content.Script);
            await ShowChoices(data.Content.Choices);
            $("#sendButton").show("slow");
          }
        }
      });
    }

    function FetchPlayerChoices() {
      $.ajax({
        url: "/getCharacters",
        dataType: "jsonp",
        success: async function (data) {
          console.log(data);
          if (data.Success) {
            for (const key in data.Content) {
              const element = data.Content[key];
              var newEle = "<li><h3>" + key + "</h3><br/>" + element + "<br/><button class=\"selectCharacter\">Select</button></li>";
              $("#PlayerSelect ul").append(newEle);
            }
            $("button.selectCharacter").click(function(btn){
              var name = $(btn.target).siblings("h3")[0].innerText;
              SelectCharacter(name);
            });
          }
        }
      });
    }

    function SelectCharacter(name){
      $.ajax({
        url: "/GetNewPlayerId/" + name,
        dataType: "jsonp",
        success: async function (data) {
          console.log(data);
          if (data.Success) {
            playerId = data.Content;
            GoToGame();
          }
        }
      });
    }

    async function GoToGame(){
      $("#PlayerSelect").hide(100);
      await sleep(100);
      $("#GameScreen").show(500);

      setInterval(FetchEventIdPlease, 500);
    }


    $(document).ready(function () {
      //PlayerSelect
      FetchPlayerChoices();


      //Game
      $("#GameScreen").hide();
      $("#sendButton").hide();

      $("button").click(function () {
        var choiceId = $("input:radio:checked")[0].value;
        $.ajax({
          url: "/user/1/answer/" + choiceId,
          dataType: "jsonp",
          success: async function (data) {
            console.log(data);
          }
        });
      });



    });
  </script>
</head>





<body>
  <div id="PlayerSelect">
    <ul>

    </ul>
  </div>

  <div id="GameScreen">
    <div id="output"></div>
    <div id="choices">
      <ul>
      </ul>
      <button id="sendButton">Send</button><br><br>
    </div>
  </div>

</body>

</html>