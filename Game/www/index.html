<!DOCTYPE html>
<html>

<head>
  <style>
    ul {
      list-style: none;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function ShowNode(node) {
      switch (node.Type) {
        case "Text":
          $("#output").append(node.Value);
          break;
        case "Break":
          $("#output").append("<br/>");
          break;
        case "Delay":
          await sleep(node.Time * 1000);
          break;
        case "Sequence":
          for (let i = 0; i < node.Children.length; i++) {
            const element = node.Children[i];
            await ShowNode(element);
          }
          break;
      }
    }

    async function ShowChoices(choices) {
      //console.log(choices);
      choices.forEach(function (choice) {
        choice = "<li> <label><input type=\"radio\" name=\"choice\" value=\"" + choice.Identifier + "\">" + choice.Label + "</label></li>";
        $("#choices ul").append(choice);
      });
      var btns = $("#choices ul li");
      btns.hide();
      for (let i = 1; i <= btns.length; i++) {
        var select = $("#choices ul li:nth-child("+i+")");
        select.show(200);
        await sleep(200);
      }

    }

    var eventId = "";
    async function EmptyContent() {
      $("#sendButton").hide(200);
      await sleep(200);
      $("#choices ul").hide(200)
      await sleep(200);
      $("#output").hide(200);
      await sleep(300);
    
      $("#choices ul").empty();
      $("#output").empty();

      $("#choices ul").show();
      $("#output").show();
    }

    function FetchEventIdPlease() {
      $.ajax({
        url: "/user/1/getCurrentEventId",
        dataType: "jsonp",
        success: async function (data) {
          if (data.Success && data.Content != eventId) {
            console.log("Event changed from " + eventId + " to " + data.Content);
            eventId = data.Content;
            await EmptyContent();
            FetchEventContent();
          }
        }
      });
    }

    function FetchEventContent() {
      $.ajax({
        url: "/user/1/getEventContent",
        dataType: "jsonp",
        success: async function (data) {
          //console.log(data);
          if (data.Success) {
            await ShowNode(data.Content.Script);
            await ShowChoices(data.Content.Choices);
            $("#sendButton").show("slow");
          }
        }
      });
    }


    $(document).ready(function () {
      setInterval(FetchEventIdPlease, 500);

      $("#sendButton").hide();

      $("button").click(function () {
        var choiceId = $("input:radio:checked")[0].value;
        $.ajax({
          url: "/user/1/answer/" + choiceId,
          dataType: "jsonp",
          success: async function (data) {
            console.log(data);
            if (data.Success) {
              /*
              await ShowNode(data.Content.Script);
              ShowChoices(data.Content.Choices);
              $("#sendButton").show("slow");
              */
            }
          }
        });
      });



    });
  </script>
</head>

<body>

  <div id="output"></div>
  <div id="choices">
    <ul>
    </ul>
    <button id="sendButton">Send</button><br><br>
  </div>

</body>

</html>